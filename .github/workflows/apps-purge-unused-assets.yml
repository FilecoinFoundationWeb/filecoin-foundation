name: Automated Asset Cleanup

on:
  schedule:
    - cron: "0 2 1 * *"
  workflow_dispatch:

concurrency:
  group: asset-cleanup
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: npm install --prefer-offline || npm install --prefer-offline

      - name: Run Asset Cleanup Scan
        id: cleanup
        run: |
          set -euo pipefail

          # Run the cleanup script in dry-run mode
          node scripts/purge-unused-assets.js --dry-run

          # Check if any assets would actually be deleted by reading the report
          if [ -f "scripts/unused-assets-report.txt" ] && grep -Eq "Total unused:\s*[1-9][0-9]*" scripts/unused-assets-report.txt; then
            echo "has_unused=true" >> $GITHUB_OUTPUT
          else
            echo "has_unused=false" >> $GITHUB_OUTPUT
          fi

      - name: Run cleanup script
        if: steps.cleanup.outputs.has_unused == 'true'
        run: |
          # Run cleanup script for real (no dry-run)
          node scripts/purge-unused-assets.js

      - name: Create Pull Request
        if: steps.cleanup.outputs.has_unused == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          title: "[AUTOMATED][SHARED] Clean up unused assets [skip percy]"
          body: |
            ## 📝 Description

            Automated cleanup of unused assets detected in the codebase. This script scanned all apps and found assets that are no longer referenced in source code.

            - **Type:** Refactor

            ## 🛠️ Key Changes

            - Removed unused assets across all apps
            - Freed up storage space in the repository

            ## 📌 To-Do Before Merging

            - [ ] Review each deleted file to ensure it's truly unused
            - [ ] Confirm no breaking changes in development environments

            ## 🧪 How to Test

            - **Setup:** No setup required - this is asset cleanup only
            - **Steps to Test:**
              1. Review the list of deleted files in the "Files changed" tab
              2. Search codebase for any references that might have been missed
              3. Verify all apps still build and run correctly
            - **Expected Results:** All applications function normally with no missing assets
            - **Additional Notes:** If any asset was incorrectly flagged, you can restore it before merging this PR

            ## 🔖 Resources

            - [Purge unused assets workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Purge unused assets script source](https://github.com/${{ github.repository }}/blob/main/scripts/purge-unused-assets.js)

      - name: Notify Slack - Cleanup PR Created
        if: steps.cleanup.outputs.has_unused == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
              "text": "🧹 Automated Asset Cleanup action completed: Unused assets found - <${{ steps.cpr.outputs.pull-request-url }}|Review PR> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
            }

      - name: Notify Slack - No Cleanup Needed
        if: steps.cleanup.outputs.has_unused == 'false'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
              "text": "🧹 Automated Asset Cleanup action completed: No unused assets found - Repository is clean!"
            }
