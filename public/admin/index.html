<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      // VIDEO WIDGET
      function renderVideoIframe(src, title = 'Video Player') {
        return `<iframe
              src="${src}"
              title="${title}"
              height="315"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>`
      }

      function renderSpan(text) {
        return `<span>${text}</span>`
      }

      function renderLink(link, text) {
        return `<a href="${link}" target="_blank" title=${text}>${text}</a>`
      }

      function renderVideoComponent(data) {
        const {
          src,
          title,
          captionLink1,
          captionText1,
          captionLink2,
          captionText2,
        } = data

        if (!src) {
          return ''
        }

        if (!captionLink1 && !captionText1 && !captionLink2 && !captionText2) {
          return renderVideoIframe(src, title)
        }

        let firstCaption = ''
        let secondCaption = ''

        if (captionText1) {
          firstCaption = renderSpan(captionText1)
        }
        if (captionText1 && captionLink1) {
          firstCaption = renderLink(captionLink1, captionText1)
        }

        if (captionText2) {
          secondCaption = renderSpan(captionText2)
        }
        if (captionText2 && captionLink2) {
          secondCaption = renderLink(captionLink2, captionText2)
        }

        return `<figure>
            ${renderVideoIframe(src, title)}
            <figcaption>${firstCaption} ${secondCaption}</figcaption>
          </figure>`
      }

      CMS.registerEditorComponent({
        id: 'video',
        label: 'Video Player',
        fields: [
          {
            name: 'src',
            label: 'Embedded Video URL',
            widget: 'string',
          },
          {
            name: 'title',
            label: 'Video Description (for screen readers)',
            widget: 'string',
          },
          {
            name: 'captionText1',
            label: 'First Caption Text',
            widget: 'string',
          },
          {
            name: 'captionLink1',
            label: 'First Caption URL',
            widget: 'string',
          },
          {
            name: 'captionText2',
            label: 'Second Caption Text',
            widget: 'string',
          },
          {
            name: 'captionLink2',
            label: 'Second Caption URL',
            widget: 'string',
          },
        ],
        pattern:
          /^<figure>\s*<iframe src="(.*?)"[^>]*><\/iframe>\s*<figcaption>(.*)<\/figcaption>\s*<\/figure>$/ms,
        fromBlock: function (match) {
          return {
            src: match[1],
            title: match[2],
            captionLink1: match[3],
            captionText1: match[4],
            captionLink2: match[5],
            captionText2: match[6],
          }
        },
        toBlock: renderVideoComponent,
        toPreview: renderVideoComponent,
      })
    </script>
    <script>
      // SOUNDCLOUD WIDGET
      function renderAudioIframe(src, title = 'Audio Player') {
        return `<iframe
              src="${src}"
              title="${title}"
              height="166"
              frameborder="0"
              scrolling="no"
              allow="autoplay"
            ></iframe>`
      }

      function renderSpan(text) {
        return `<span>${text}</span>`
      }

      function renderLink(link, text) {
        return `<a target="_blank" title=${text} href="${link}">${text}</a>`
      }

      function renderAudioComponent(data) {
        const {
          src,
          title,
          captionLink1,
          captionText1,
          captionLink2,
          captionText2,
        } = data

        if (!src) {
          return ''
        }

        if (!captionLink1 && !captionText1 && !captionLink2 && !captionText2) {
          return renderAudioIframe(src, title)
        }

        let firstCaption = ''
        let secondCaption = ''

        if (captionText1) {
          firstCaption = renderSpan(captionText1)
        }
        if (captionText1 && captionLink1) {
          firstCaption = renderLink(captionLink1, captionText1)
        }

        if (captionText2) {
          secondCaption = renderSpan(captionText2)
        }
        if (captionText2 && captionLink2) {
          secondCaption = renderLink(captionLink2, captionText2)
        }

        return `<figure>
            ${renderAudioIframe(src, title)}
            <figcaption>${firstCaption} ${secondCaption}</figcaption>
          </figure>`
      }

      CMS.registerEditorComponent({
        id: 'audio',
        label: 'Audio Player',
        fields: [
          {
            name: 'src',
            label: 'Embedded Audio URL',
            widget: 'string',
            required: true,
          },
          {
            name: 'title',
            label: 'Audio Description (for screen readers)',
            widget: 'string',
          },
          {
            name: 'captionText1',
            label: 'First Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink1',
            label: 'First Caption URL',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionText2',
            label: 'Second Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink2',
            label: 'Second Caption URL',
            widget: 'string',
            required: false,
          },
        ],
        pattern:
          /^<figure>\s*<iframe src="(.*?)"[^>]*><\/iframe>\s*<figcaption>(.*)<\/figcaption>\s*<\/figure>$/ms,
        fromBlock: function (match) {
          return {
            src: match[1],
            title: match[2],
            captionLink1: match[3],
            captionText1: match[4],
            captionLink2: match[5],
            captionText2: match[6],
          }
        },
        toBlock: renderAudioComponent,
        toPreview: renderAudioComponent,
      })
    </script>
  </body>
</html>
