<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      const regExp =
        /^<figure>\s*<iframe src="(.*?)"[^>]*><\/iframe>\s*<figcaption>(.*)<\/figcaption>\s*<\/figure>$/ms

      function renderSpan(text) {
        return `<span>${text}</span>`
      }

      function renderLink(link, text) {
        return `<a href="${link}" target="_blank" title=${text}>${text}</a>`
      }

      function getMatches(match) {
        return {
          src: match[1],
          title: match[2],
          captionLink1: match[3],
          captionText1: match[4],
          captionLink2: match[5],
          captionText2: match[6],
        }
      }

      function renderCaptions(data) {
        const { captionText1, captionLink1, captionText2, captionLink2 } = data

        let firstCaption = ''
        let secondCaption = ''

        if (captionText1) {
          firstCaption = renderSpan(captionText1)
        }
        if (captionText1 && captionLink1) {
          firstCaption = renderLink(captionLink1, captionText1)
        }

        if (captionText2) {
          secondCaption = renderSpan(captionText2)
        }
        if (captionText2 && captionLink2) {
          secondCaption = renderLink(captionLink2, captionText2)
        }

        return `<figcaption>${firstCaption} ${secondCaption}</figcaption>`
      }
    </script>
    <script>
      function renderVideoIframe(src, title = 'Video Player') {
        return `<iframe
              src="${src}"
              title="${title}"
              height="315"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>`
      }

      function renderVideoComponent(data) {
        const { src, title, ...captions } = data

        if (!src) {
          return ''
        }

        const hasNoCaptions = Object.keys(captions).length === 0

        if (hasNoCaptions) {
          return renderVideoIframe(src, title)
        }

        return `<figure>
            ${renderVideoIframe(src, title)}
            ${renderCaptions(captions)}
          </figure>`
      }

      CMS.registerEditorComponent({
        id: 'video',
        label: 'Video Player',
        fields: [
          {
            name: 'src',
            label: 'Embedded Video URL',
            widget: 'string',
            required: true,
          },
          {
            name: 'title',
            label: 'Video Description (for screen readers)',
            widget: 'string',
            required: true,
          },
          {
            name: 'captionText1',
            label: 'First Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink1',
            label: 'First Caption URL',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionText2',
            label: 'Second Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink2',
            label: 'Second Caption URL',
            widget: 'string',
            required: false,
          },
        ],
        pattern: regExp,
        fromBlock: getMatches,
        toBlock: renderVideoComponent,
        toPreview: renderVideoComponent,
      })
    </script>
    <script>
      function renderAudioIframe(src, title = 'Audio Player') {
        return `<iframe
              src="${src}"
              title="${title}"
              height="166"
              frameborder="0"
              scrolling="no"
              allow="autoplay"
            ></iframe>`
      }

      function renderAudioComponent(data) {
        const { src, title, ...captions } = data

        if (!src) {
          return ''
        }

        const hasNoCaptions = Object.keys(captions).length === 0

        if (hasNoCaptions) {
          return renderAudioIframe(src, title)
        }

        return `<figure>
            ${renderAudioIframe(src, title)}
            ${renderCaptions(captions)}
          </figure>`
      }

      CMS.registerEditorComponent({
        id: 'audio',
        label: 'Audio Player',
        fields: [
          {
            name: 'src',
            label: 'Embedded Audio URL',
            widget: 'string',
            required: true,
          },
          {
            name: 'title',
            label: 'Audio Description (for screen readers)',
            widget: 'string',
            required: true,
          },
          {
            name: 'captionText1',
            label: 'First Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink1',
            label: 'First Caption URL',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionText2',
            label: 'Second Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink2',
            label: 'Second Caption URL',
            widget: 'string',
            required: false,
          },
        ],
        pattern: regExp,
        fromBlock: getMatches,
        toBlock: renderAudioComponent,
        toPreview: renderAudioComponent,
      })
    </script>
  </body>
</html>
