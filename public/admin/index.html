<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      function renderIframe(src) {
        return `<iframe
              src="${src}"
              width="560"
              height="315"
              frameborder="0"
              allow="autoplay; encrypted-media"
              allowfullscreen
            ></iframe>`
      }

      function renderSpan(text) {
        return `<span>${text}</span>`
      }

      function renderLink(link, text) {
        return `<a href="${link}">${text}</a>`
      }

      function renderVideoComponent(data) {
        const { src, captionLink1, captionText1, captionLink2, captionText2 } =
          data

        if (!src) {
          return ''
        }

        if (!captionLink1 && !captionText1 && !captionLink2 && !captionText2) {
          return renderIframe(src)
        }

        let firstCaption = ''
        let secondCaption = ''

        if (captionText1) {
          firstCaption = renderSpan(captionText1)
        }
        if (captionText1 && captionLink1) {
          firstCaption = renderLink(captionLink1, captionText1)
        }

        if (captionText2) {
          secondCaption = renderSpan(captionText2)
        }
        if (captionText2 && captionLink2) {
          secondCaption = renderLink(captionLink2, captionText2)
        }

        return `<figure>
            ${renderIframe(src)}
            <figcaption>${firstCaption} ${secondCaption}</figcaption>
          </figure>`
      }

      CMS.registerEditorComponent({
        id: 'video',
        label: 'Video',
        fields: [
          {
            name: 'src',
            label: 'Embedded Video URL',
            widget: 'string',
            required: true,
          },
          {
            name: 'captionText1',
            label: 'First Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink1',
            label: 'First Caption URL',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionText2',
            label: 'Second Caption Text',
            widget: 'string',
            required: false,
          },
          {
            name: 'captionLink2',
            label: 'Second Caption URL',
            widget: 'string',
            required: false,
          },
        ],
        pattern:
          /^<figure>\s*<iframe src="(.*?)"[^>]*><\/iframe>\s*<figcaption>(.*)<\/figcaption>\s*<\/figure>$/ms,
        fromBlock: function (match) {
          return {
            src: match[1] || '',
            captionLink1: match[2] || '',
            captionText1: match[3] || '',
            captionLink2: match[4] || '',
            captionText2: match[5] || '',
          }
        },
        toBlock: renderVideoComponent,
        toPreview: renderVideoComponent,
      })
    </script>
  </body>
</html>
